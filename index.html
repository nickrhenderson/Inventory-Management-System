<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Inventory System</title>
    <style>
        /* Critical styles to prevent FOUC - must be inline and first */
        /* Prevent scroll while loading */
        body:not(.loaded) {
            overflow: hidden !important;
        }
        
        /* Show only the loading screen initially */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            visibility: visible !important;
            opacity: 1;
            transition: opacity 240ms ease, visibility 0s linear 240ms;
            will-change: opacity;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007acc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        .loading-text {
            color: #666;
            font-size: 18px;
            font-weight: 500;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* When loaded, fade out loading screen and fade in content */
        body.loaded {
            /* Keep overflow behavior consistent with app CSS to avoid layout shifts */
            overflow: hidden !important;
        }
        
        body.loaded #loading-screen {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .app-shell {
            /* Preserve original full-height flex layout (header/tabs fixed, main stretches) */
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            width: 100%;
            opacity: 0;
            /* NOTE: Avoid transform here; it breaks position:fixed children (modal backdrops) */
            transition: opacity 260ms ease;
            will-change: opacity;
        }
        
        body.loaded .app-shell {
            opacity: 1;
        }
    </style>
    <link rel="stylesheet" href="static/styles.css">
    <script src="static/main.js" defer></script>
    <script>
        const pageLoadStart = Date.now();
        let stylesReady = false;
        let appReady = false;
        let loadingCleared = false;
        
        window.loadingScreenComplete = false;
        
        // Function to trigger all pending animations
        window.triggerPendingAnimations = function() {
            console.log('Triggering pending animations...');
            
            if (window.pendingProductAnimation) {
                window.pendingProductAnimation();
                window.pendingProductAnimation = null;
            }
            
            if (window.pendingIngredientAnimation) {
                window.pendingIngredientAnimation();
                window.pendingIngredientAnimation = null;
            }
        };
        
        function startReveal() {
            if (loadingCleared) return;
            loadingCleared = true;

            const loadingScreen = document.getElementById('loading-screen');
            let revealed = false;

            const finishReveal = function() {
                if (revealed) return;
                revealed = true;

                // Give the app-shell fade a beat to finish before kicking off row/group animations
                setTimeout(function() {
                    window.loadingScreenComplete = true;
                    if (window.triggerPendingAnimations) {
                        window.triggerPendingAnimations();
                    }
                    console.log('App revealed in', Date.now() - pageLoadStart, 'ms');
                }, 90);
            };

            // When the loading screen fade finishes, mark loading complete and trigger animations.
            if (loadingScreen) {
                loadingScreen.addEventListener('transitionend', function(e) {
                    if (e.propertyName === 'opacity') {
                        finishReveal();
                    }
                }, { once: true });
            }

            // Start transitions on next frame (helps ensure the fade runs)
            requestAnimationFrame(function() {
                document.body.classList.add('loaded');
            });

            // Fallback: in case transitionend doesn't fire
            setTimeout(finishReveal, 450);
        }

        function maybeShowApp() {
            if (stylesReady && appReady) {
                startReveal();
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const styleLink = document.querySelector('link[href*="styles.css"]');
            if (styleLink) {
                styleLink.addEventListener('load', function() {
                    stylesReady = true;
                    maybeShowApp();
                });
            } else {
                // Fallback if link not found
                stylesReady = true;
                maybeShowApp();
            }
        });
        
        // Catch the app readiness event from main.js / initializeApp
        window.addEventListener('app:initialized', function() {
            appReady = true;
            maybeShowApp();
        });
        
        // If initialization fails, log the error and still attempt to show the UI
        window.addEventListener('app:failed', function(event) {
            console.error('App failed to initialize:', event.detail);
            appReady = true; // allow UI to render so error states can be visible
            maybeShowApp();
        });
        
        // Fallback: ensure loading screen does not hang forever
        window.addEventListener('load', function() {
            if (!stylesReady) {
                stylesReady = true;
                maybeShowApp();
            }
            // Safety net to clear the loading screen after 12s regardless
            setTimeout(function() {
                if (!loadingCleared) {
                    console.warn('Forcing loading screen to hide after timeout');
                    startReveal();
                }
            }, 12000);
        });
    </script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Inventory System...</div>
        </div>
    </div>
    
    <div class="app-shell">
    <!-- Top Navigation Bar -->
    <header class="top-bar">
        <div class="search-container">
            <input class="search-bar" type="text" placeholder="Search..." autocomplete="off">
            <div class="search-icon">
                <img src="static/img/svg/magnifyglass.svg" alt="Search" />
            </div>
        </div>
        <button class="top-bar-button version-button" title="Version" id="versionButton">
            v0.3.3
        </button>
    </header>

    <!-- Tabs -->
    <nav class="tabs" id="mainTabs">
        <button class="tab active" data-tab="inventory">Inventory</button>
        <button class="tab" data-tab="events">Events</button>
    </nav>
    
    <!-- Main Application Content -->
    <main class="main">
        <!-- Inventory View -->
        <div class="tab-view" id="inventoryView">
            <section class="box left">
                <div class="inventory-container">
                    <div id="inventoryTable"></div>
                </div>
            </section>
            
            <section class="box right">
                <div class="ingredients-container">
                    <div id="rightBoxContent"></div>
                </div>
                <footer class="ingredients-total-fixed" id="ingredientsTotalFixed"></footer>
            </section>
        </div>

        <!-- Events View -->
        <div class="tab-view" id="eventsView" style="display:none;">
            <section class="box left">
                <div class="events-container">
                    <div id="eventsList"></div>
                </div>
            </section>
            <section class="box right">
                <div class="events-detail-placeholder">
                    <p>Event details will appear here.</p>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item inventory-only" onclick="openProductModal(); hideContextMenu()">
            <img src="static/img/svg/plus.svg" alt="Add" class="menu-icon" />
            <span>Add Product</span>
        </div>
        <div class="context-menu-item inventory-only" onclick="openIngredientModal(); hideContextMenu()">
            <img src="static/img/svg/plus.svg" alt="Add" class="menu-icon" />
            <span>Add Ingredient</span>
        </div>
        <div class="context-menu-item inventory-only" onclick="openGroupModal(); hideContextMenu()">
            <img src="static/img/svg/plus.svg" alt="Add" class="menu-icon" />
            <span>Create Group</span>
        </div>
        <div class="context-menu-item events-only" onclick="openEventModal(); hideContextMenu()" style="display:none;">
            <img src="static/img/svg/plus.svg" alt="Add" class="menu-icon" />
            <span>Add Event</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="refreshFiles(); hideContextMenu()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="menu-icon">
                <path d="M21 3V8M21 8H16M21 8L18 5.29168C16.4077 3.86656 14.3051 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.2832 21 19.8675 18.008 20.777 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Refresh</span>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Product Creation Modal -->
    <div class="modal-backdrop creation-modal-backdrop" id="productModalBackdrop" onclick="closeProductModal()">
        <div class="modal-content creation-modal" id="productModal" onclick="event.stopPropagation()">
            <button class="modal-close-button" onclick="closeProductModal()" title="Close">×</button>
            <h3>Add Product</h3>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" name="productName" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="mixedDate">Mixed Date:</label>
                    <input type="date" id="mixedDate" name="mixedDate" required>
                </div>
                <div class="form-group">
                    <label for="productAmount">Number of Batches Produced:</label>
                    <input type="number" id="productAmount" name="productAmount" min="0" step="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="productGroup">Assign to Group:</label>
                    <select id="productGroup" name="productGroup">
                        <option value="">None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="barcodeScanner">Scan Ingredient Barcode:</label>
                    <input type="text" id="barcodeScanner" name="barcodeScanner" placeholder="Scan or type barcode..." autocomplete="off">
                    <div class="barcode-status" id="barcodeStatus"></div>
                </div>
                <div class="form-group">
                    <label for="ingredientSelection">Select Ingredients:</label>
                    <div class="ingredient-selector" id="ingredientSelector"></div>
                </div>
                <div class="selected-ingredients" id="selectedIngredients"></div>
                <!-- Dynamic Group Parameters (shown when a group with parameters is selected) -->
                <div class="form-group" id="productGroupParametersWrapper" style="display:none;">
                    <label>Group Custom Fields:</label>
                    <div id="productGroupParametersContainer"></div>
                </div>
                <div class="form-actions">
                    <button type="button" class="modal-button cancel" onclick="closeProductModal()">Cancel</button>
                    <button type="submit" class="modal-button submit" id="submitProductButton">Add Product</button>
                </div>
            </form>
            <div class="barcode-result" id="barcodeResult" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Ingredient Creation Modal -->
    <div class="modal-backdrop creation-modal-backdrop" id="ingredientModalBackdrop" onclick="closeIngredientModal()">
        <div class="modal-content creation-modal" id="ingredientModal" onclick="event.stopPropagation()">
            <button class="modal-close-button" onclick="closeIngredientModal()" title="Close">×</button>
            <h3>Add Ingredient</h3>
            <form id="ingredientForm">
                <div class="form-group">
                    <label for="ingredientName">Ingredient Name:</label>
                    <input type="text" id="ingredientName" name="ingredientName" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="ingredientUnitCost">Unit Cost (per gram) ($):</label>
                    <input type="number" id="ingredientUnitCost" name="ingredientUnitCost" step="0.001" min="0" required>
                </div>
                <div class="form-group">
                    <label for="ingredientPurchaseDate">Purchase Date:</label>
                    <input type="date" id="ingredientPurchaseDate" name="ingredientPurchaseDate" required>
                </div>
                <div class="form-group">
                    <label for="ingredientExpirationDate">Expiration Date:</label>
                    <input type="date" id="ingredientExpirationDate" name="ingredientExpirationDate" required>
                </div>
                <div class="form-group">
                    <label for="ingredientSupplier">Supplier:</label>
                    <input type="text" id="ingredientSupplier" name="ingredientSupplier" required autocomplete="off">
                </div>
                <div class="form-actions">
                    <button type="button" class="modal-button cancel" onclick="closeIngredientModal()">Cancel</button>
                    <button type="submit" class="modal-button submit" id="submitIngredientButton">Add Ingredient</button>
                </div>
            </form>
            <div class="barcode-result" id="ingredientBarcodeResult" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Group Creation Modal -->
    <div class="modal-backdrop creation-modal-backdrop" id="groupModalBackdrop" onclick="closeGroupModal()">
        <div class="modal-content creation-modal" id="groupModal" onclick="event.stopPropagation()">
            <button class="modal-close-button" onclick="closeGroupModal()" title="Close">×</button>
            <h3>Create New Group</h3>
            <form id="groupForm">
                <div class="form-group">
                    <label for="groupName">Group Name:</label>
                    <input type="text" id="groupName" name="groupName" required autocomplete="off" placeholder="Enter group name...">
                </div>
                <div class="form-group" id="groupParametersSection">
                    <label>Custom Parameters (optional):</label>
                    <div id="groupParametersContainer"></div>
                    <button type="button" class="modal-button submit" id="addGroupParameterButton" onclick="addGroupParameterField()" style="margin-top:10px; background:#007acc;">Add Parameter</button>
                </div>
                <div class="form-actions">
                    <button type="button" class="modal-button cancel" onclick="closeGroupModal()">Cancel</button>
                    <button type="submit" class="modal-button submit" id="submitGroupButton">Create Group</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Creation Modal -->
    <div class="modal-backdrop creation-modal-backdrop" id="eventModalBackdrop" onclick="closeEventModal()" style="display:none;">
        <div class="modal-content creation-modal" id="eventModal" onclick="event.stopPropagation()">
            <button class="modal-close-button" onclick="closeEventModal()" title="Close">×</button>
            <h3>Add Inventory Event</h3>
            <form id="eventForm">
                <div class="form-group">
                    <label for="eventDate">Event Date:</label>
                    <input type="date" id="eventDate" name="eventDate" required>
                </div>
                <div class="form-group">
                    <label for="eventTitle">Title:</label>
                    <input type="text" id="eventTitle" name="eventTitle" placeholder="Adjustment, Restock, etc." required>
                </div>
                <div class="form-group">
                    <label for="eventProductSelection">Select Products:</label>
                    <div class="event-product-selector" id="eventProductSelector"></div>
                </div>
                <div class="selected-event-products" id="selectedEventProducts"></div>
                <div class="form-actions">
                    <button type="button" class="modal-button cancel" onclick="closeEventModal()">Cancel</button>
                    <button type="submit" class="modal-button submit" id="submitEventButton">Save Event</button>
                </div>
            </form>
        </div>
    </div>
    </div>
</body>
</html>

